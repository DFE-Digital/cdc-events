{"$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#","parameters":{"serviceIdentifier":{"type":"string","minLength":4,"maxLength":4},"environment":{"type":"string","defaultValue":"d","allowedValues":["d","t","p"]},"environmentName":{"type":"string","defaultValue":"DEV","allowedValues":["DEV","TEST","OAT","PROD"]},"environmentInstance":{"type":"string","minLength":2,"maxLength":2,"defaultValue":"01"},"sharedResourcesAppName":{"type":"string","defaultValue":"common"},"eapimPublicIpAddress":{"type":"string"},"keyVaultInstance":{"type":"string","minLength":2,"maxLength":2,"defaultValue":"01"},"keyVaultSecretNameCdcEventsSubscriptionKey":{"type":"string","defaultValue":"cdc-events-subscription-key"},"keyVaultSecretNameKycloudApiPassword":{"type":"string","defaultValue":"kycloud-api-password"},"keyVaultSecretNameKycloudApiToken":{"type":"string","defaultValue":"kycloud-api-token"},"keyVaultSecretNameCdcEventsTokenRequestPayload":{"type":"string","defaultValue":"cdc-events-token-request-payload"},"cdcEventsApiBaseUri":{"type":"string"},"kycloudApiBaseUri":{"type":"string"},"kycloudApiEmail":{"type":"string"},"loginEndpoint":{"type":"string","defaultValue":"user/login"},"dataPathPrefix":{"type":"string","defaultValue":"data"},"internalOAuthTokenEndpoint":{"type":"string"},"appName":{"type":"string","defaultValue":"cdcaeg"},"appInstance":{"type":"string","defaultValue":"01"}},"variables":{"singleQuote":"\u0027","namePrefix":"[concat(parameters(\u0027serviceIdentifier\u0027), parameters(\u0027environment\u0027), parameters(\u0027environmentInstance\u0027))]","sharedResourceGroupName":"[concat(variables(\u0027namePrefix\u0027), \u0027-\u0027, parameters(\u0027sharedResourcesAppName\u0027))]","keyVaultName":"[concat(variables(\u0027namePrefix\u0027), \u0027-kv-\u0027, parameters(\u0027keyVaultInstance\u0027))]","logicAppName":"[concat(variables(\u0027namePrefix\u0027), \u0027-\u0027, parameters(\u0027appName\u0027), \u0027-la-\u0027, parameters(\u0027appInstance\u0027))]","logicAppId":"[resourceId(\u0027Microsoft.Logic/workflows/\u0027, variables(\u0027logicAppName\u0027))]","keyVaultSecretCdcEventsSubscriptionKey":"[resourceId(variables(\u0027sharedResourceGroupName\u0027), \u0027Microsoft.KeyVault/vaults/secrets\u0027, variables(\u0027keyVaultName\u0027), parameters(\u0027keyVaultSecretNameCdcEventsSubscriptionKey\u0027))]","keyVaultSecretKycloudApiPassword":"[resourceId(variables(\u0027sharedResourceGroupName\u0027), \u0027Microsoft.KeyVault/vaults/secrets\u0027, variables(\u0027keyVaultName\u0027), parameters(\u0027keyVaultSecretNameKycloudApiPassword\u0027))]","keyVaultSecretKycloudApiToken":"[resourceId(variables(\u0027sharedResourceGroupName\u0027), \u0027Microsoft.KeyVault/vaults/secrets\u0027, variables(\u0027keyVaultName\u0027), parameters(\u0027keyVaultSecretNameKycloudApiToken\u0027))]","keyVaultSecretCdcEventsTokenRequestPayload":"[resourceId(variables(\u0027sharedResourceGroupName\u0027), \u0027Microsoft.KeyVault/vaults/secrets\u0027, variables(\u0027keyVaultName\u0027), parameters(\u0027keyVaultSecretNameCdcEventsTokenRequestPayload\u0027))]","loginUri":"[concat(parameters(\u0027kycloudApiBaseUri\u0027), \u0027/\u0027, parameters(\u0027loginEndpoint\u0027))]","dataPathUri":"[concat(parameters(\u0027kycloudApiBaseUri\u0027), \u0027/\u0027, parameters(\u0027dataPathPrefix\u0027))]"},"resources":[{"apiVersion":"2017-07-01","type":"Microsoft.Logic/workflows","name":"[variables(\u0027logicAppName\u0027)]","location":"[resourceGroup().location]","tags":{"environment":"[parameters(\u0027environmentName\u0027)]","app":"[parameters(\u0027appName\u0027)]"},"identity":{"type":"SystemAssigned"},"properties":{"state":"Enabled","definition":{"$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#","actions":{"Init-Control-Attachments":{"inputs":{"variables":[{"name":"Control-Attachments","type":"array","value":[]}]},"runAfter":{"Init-SourceOAUTHToken":["Succeeded"]},"type":"InitializeVariable"},"Init-Control-Continue":{"inputs":{"variables":[{"name":"Control-Continue","type":"boolean","value":"@true"}]},"runAfter":{"Init-Control-Continue-Step":["Succeeded"]},"type":"InitializeVariable"},"Init-Control-Continue-Step":{"inputs":{"variables":[{"name":"Control-Continue-Step","type":"boolean","value":"@true"}]},"runAfter":{"Init-Control-Since":["Succeeded"]},"type":"InitializeVariable"},"Init-Control-Error":{"inputs":{"variables":[{"name":"Control-Error","type":"integer","value":0}]},"runAfter":{"Init-Control-Status":["Succeeded"]},"type":"InitializeVariable"},"Init-Control-Page":{"inputs":{"variables":[{"name":"Control-Page","type":"integer","value":1}]},"runAfter":{"Init-Control-Continue":["Succeeded"]},"type":"InitializeVariable"},"Init-Control-Since":{"inputs":{"variables":[{"name":"Control-Since","type":"string","value":"@{null}"}]},"runAfter":{"Init-Control-Started":["Succeeded"]},"type":"InitializeVariable"},"Init-Control-Started":{"inputs":{"variables":[{"name":"Control-Started","type":"string","value":"@{utcNow()}"}]},"runAfter":{"Init-Control-Error":["Succeeded"]},"type":"InitializeVariable"},"Init-Control-Status":{"inputs":{"variables":[{"name":"Control-Status","type":"integer","value":1}]},"runAfter":{},"type":"InitializeVariable"},"Init-SourceOAUTHKey":{"inputs":{"variables":[{"name":"SourceOAUTHKey","type":"string","value":"@{null}"}]},"runAfter":{"Init-Control-Page":["Succeeded"]},"type":"InitializeVariable"},"Init-SourceOAUTHSecret":{"inputs":{"variables":[{"name":"SourceOAUTHSecret","type":"string","value":"@{null}"}]},"runAfter":{"Init-SourceOAUTHKey":["Succeeded"]},"type":"InitializeVariable"},"Init-SourceOAUTHToken":{"inputs":{"variables":[{"name":"SourceOAUTHToken","type":"string","value":"@{null}"}]},"runAfter":{"Init-TargetOAUTHToken":["Succeeded"]},"type":"InitializeVariable"},"Init-TargetOAUTHCredentials":{"inputs":{"variables":[{"name":"TargetOAUTHCredentials","type":"string","value":"@{null}"}]},"runAfter":{"Init-TargetOAUTHKey":["Succeeded"]},"type":"InitializeVariable"},"Init-TargetOAUTHKey":{"inputs":{"variables":[{"name":"TargetOAUTHKey","type":"string","value":"@{null}"}]},"runAfter":{"Init-SourceOAUTHSecret":["Succeeded"]},"type":"InitializeVariable"},"Init-TargetOAUTHToken":{"inputs":{"variables":[{"name":"TargetOAUTHToken","type":"string","value":"@{null}"}]},"runAfter":{"Init-TargetOAUTHCredentials":["Succeeded"]},"type":"InitializeVariable"},"Scope-Attachments":{"actions":{"For_each_attachment":{"actions":{"If-Post-Blob-Success":{"actions":{},"else":{"actions":{"Scope-Attachments-Fail-Post-To-Target":{"description":"Throw error to exit scope and fail run - should really check for 401 and attempt re login to target","inputs":{"name":"Control-Error","value":"@int(\u0027__ERROR_\u0027)"},"runAfter":{},"type":"SetVariable"}}},"expression":{"and":[{"equals":["@outputs(\u0027Post-blob\u0027)[\u0027statusCode\u0027]",202]}]},"runAfter":{"Post-blob":["Succeeded"]},"type":"If"},"Post-blob":{"inputs":{"body":[{"BlobData":"@body(\u0027Get-Blob\u0027)","BlobFilename":"@{items(\u0027For_each_attachment\u0027)[\u0027BlobKey\u0027]}@{items(\u0027For_each_attachment\u0027)[\u0027Extension\u0027]}","BlobFolder":"@{items(\u0027For_each_attachment\u0027)[\u0027Folder\u0027]}","BlobKey":"@items(\u0027For_each_attachment\u0027)[\u0027BlobKey\u0027]","BlobMimeType":"@items(\u0027For_each_attachment\u0027)[\u0027MimeType\u0027]","BlobObtained":"@variables(\u0027Control-Started\u0027)","BlobShare":"cdcdocuments","BlobSiteUniqueId":"@items(\u0027For_each_attachment\u0027)?[\u0027SiteUniqueId\u0027]"}],"headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/octet-stream","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)"},"method":"POST","uri":"@{parameters(\u0027TargetEndpoint\u0027)}blobs"},"runAfter":{"While-Control-Continue-Step-True":["Succeeded"]},"runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}},"type":"Http"},"While-Control-Continue-Step-True":{"actions":{"Get-Blob":{"inputs":{"headers":{"Accept":"*/*"},"method":"GET","queries":{"AsAtachment":"true","AsAttachment":"true","BlobKey":"@items(\u0027For_each_attachment\u0027)[\u0027BlobKey\u0027]","SessionId":"@variables(\u0027SourceOAUTHToken\u0027)"},"uri":"@{parameters(\u0027SourceEndpoint\u0027)}blobs"},"runAfter":{},"type":"Http"},"If-Get-Blob-Success":{"actions":{},"else":{"actions":{"If-Unauthorised":{"actions":{"Parse_relogin_after_401":{"inputs":{"content":"@body(\u0027Re_login_after_401\u0027)","schema":{"properties":{"SessionId":{"type":"string"},"Success":{"type":"boolean"}},"type":"object"}},"runAfter":{"Re_login_after_401":["Succeeded"]},"type":"ParseJson"},"Re_login_after_401":{"inputs":{"headers":{"Accept":"application/json"},"method":"POST","queries":{"ApiToken":"@variables(\u0027SourceOAUTHToken\u0027)","Email":"@parameters(\u0027KycloudApiEmail\u0027)","Password":"@variables(\u0027SourceOAUTHSecret\u0027)"},"uri":"@parameters(\u0027SourceOAUTHEndpoint\u0027)"},"runAfter":{},"type":"Http"},"Set_AttachementsSessionId_after_relogin_after_401":{"inputs":{"name":"SourceOAUTHToken","value":"@body(\u0027Parse_relogin_after_401\u0027)?[\u0027SessionId\u0027]"},"runAfter":{"Parse_relogin_after_401":["Succeeded"]},"type":"SetVariable"}},"else":{"actions":{"Set-Control-Continue-Step-False":{"inputs":{"name":"Control-Continue-Step","value":"@false"},"runAfter":{},"type":"SetVariable"},"Set-Control-Error-Get-Blob-Error":{"inputs":{"name":"Control-Error","value":"@int(\u0027__EROR__\u0027)"},"runAfter":{"Set-Control-Continue-Step-False":["Succeeded"]},"type":"SetVariable"}}},"expression":{"and":[{"equals":["",401]}]},"runAfter":{},"type":"If"}}},"expression":{"and":[{"equals":["@outputs(\u0027Get-Blob\u0027)[\u0027statusCode\u0027]",200]}]},"runAfter":{"Get-Blob":["Succeeded"]},"type":"If"}},"expression":{"and":[{"equals":["@variables(\u0027Control-Continue-Step\u0027)","@true"]}]},"runAfter":{},"type":"If"}},"foreach":"@variables(\u0027Control-Attachments\u0027)","runAfter":{},"type":"Foreach"}},"description":"Obtain all of the attachments on the list and post the data and metadata to the blobs endpoint to store the file and update the database.","runAfter":{"Scope-Source-OAUTH-Refresh":["Succeeded"]},"type":"Scope"},"Scope-Attachments-List":{"actions":{"Get-Attachments-List":{"inputs":{"headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/json","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)"},"method":"GET","uri":"@{parameters(\u0027TargetEndpoint\u0027)}attachments"},"runAfter":{},"type":"Http"},"Parse-Attachments-List":{"inputs":{"content":"@body(\u0027Get-Attachments-List\u0027)","schema":{"items":{"properties":{"BlobKey":{"type":"string"},"Extension":{"type":"string"},"Folder":{"type":"string"},"MimeType":{"type":"string"},"SiteUniqueId":{"type":"string"}},"required":["BlobKey","MimeType","Extension","Folder","SiteUniqueId"],"type":"object"},"type":"array"}},"runAfter":{"Get-Attachments-List":["Succeeded"]},"type":"ParseJson"},"Set-Control-Attachments-List":{"inputs":{"name":"Control-Attachments","value":"@body(\u0027Parse-Attachments-List\u0027)"},"runAfter":{"Parse-Attachments-List":["Succeeded"]},"type":"SetVariable"}},"runAfter":{"Scope-Update-Status-Extract":["Succeeded"]},"type":"Scope"},"Scope-Entities":{"actions":{"For_each_ApiEntitiesToPull":{"actions":{"Loop_through_pages":{"actions":{"Get-Entity-Page":{"inputs":{"headers":{"Accept":"application/json"},"method":"GET","queries":{"Page":"@{variables(\u0027Control-Page\u0027)}","PageSize":"1000","SessionId":"@variables(\u0027SourceOAUTHToken\u0027)","UpdatedSince":"@variables(\u0027Control-Since\u0027)","format":"json","jsconfig":"dh:iso8601"},"retryPolicy":{"type":"none"},"uri":"@{parameters(\u0027SourceEndpoint\u0027)}@{items(\u0027For_each_ApiEntitiesToPull\u0027)}"},"runAfter":{},"type":"Http"},"If-Entities-Received":{"actions":{"Post-Entity-Page":{"inputs":{"body":"@body(\u0027Parse-Entity-Page\u0027)?[\u0027Infos\u0027]","headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/octet-stream","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Page":"@{variables(\u0027Control-Page\u0027)}","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)"},"method":"POST","retryPolicy":{"type":"none"},"uri":"@{parameters(\u0027TargetEndpoint\u0027)}@{items(\u0027For_each_ApiEntitiesToPull\u0027)}"},"runAfter":{},"type":"Http"}},"else":{"actions":{"Set-Control-Continue-False":{"inputs":{"name":"Control-Continue","value":"@false"},"runAfter":{},"type":"SetVariable"}}},"expression":{"and":[{"greater":["@length(body(\u0027Parse-Entity-Page\u0027)[\u0027Infos\u0027])",0]}]},"runAfter":{"Increment-Control-Page":["Succeeded"]},"type":"If"},"Increment-Control-Page":{"inputs":{"name":"Control-Page","value":1},"runAfter":{"Parse-Entity-Page":["Succeeded"]},"type":"IncrementVariable"},"Parse-Entity-Page":{"inputs":{"content":"@body(\u0027Get-Entity-Page\u0027)","schema":{"properties":{"Infos":{"items":{"type":"object"},"type":"array"},"Success":{"type":"boolean"}},"type":"object"}},"runAfter":{"Get-Entity-Page":["Succeeded"]},"type":"ParseJson"}},"expression":"@equals(variables(\u0027Control-Continue\u0027), false)","limit":{"count":5000,"timeout":"PT1H"},"runAfter":{"Set-Control-Page-1":["Succeeded"]},"type":"Until"},"Set-Control-Continue-True":{"inputs":{"name":"Control-Continue","value":"@true"},"runAfter":{},"type":"SetVariable"},"Set-Control-Page-1":{"inputs":{"name":"Control-Page","value":1},"runAfter":{"Set-Control-Continue-True":["Succeeded"]},"type":"SetVariable"}},"foreach":"@parameters(\u0027SourceEntities\u0027)","runAfter":{},"runtimeConfiguration":{"concurrency":{"repetitions":1}},"type":"Foreach"}},"runAfter":{"Scope-Update-Status-Entities":["Succeeded"]},"type":"Scope"},"Scope-Get-Secrets":{"actions":{"Get_cdc-events-subscription-key":{"inputs":{"authentication":{"audience":"@parameters(\u0027SecretsAudience\u0027)","type":"ManagedServiceIdentity"},"method":"GET","uri":"@parameters(\u0027TargetOAUTHKeyUri\u0027)"},"runAfter":{"Set-SourceOAUTHSecret":["Succeeded"]},"type":"Http"},"Get_cdc-events-token-request-payload":{"inputs":{"authentication":{"audience":"@parameters(\u0027SecretsAudience\u0027)","type":"ManagedServiceIdentity"},"method":"GET","uri":"@parameters(\u0027TargetOAUTHCredentialsUri\u0027)"},"runAfter":{"Set-TargetOAUTHKey":["Succeeded"]},"type":"Http"},"Get_kycloud-api-password_from_KeyVault":{"inputs":{"authentication":{"audience":"@parameters(\u0027SecretsAudience\u0027)","type":"ManagedServiceIdentity"},"method":"GET","uri":"@parameters(\u0027SourceOAUTHSecretUri\u0027)"},"runAfter":{"Set-SourceOAUTHKey":["Succeeded"]},"type":"Http"},"Get_kycloud-api-token_from_KeyVault":{"inputs":{"authentication":{"audience":"@parameters(\u0027SecretsAudience\u0027)","type":"ManagedServiceIdentity"},"method":"GET","uri":"@parameters(\u0027SourceOAUTHKeyUri\u0027)"},"runAfter":{},"type":"Http"},"Parse_cdc-events-subscription-key":{"inputs":{"content":"@body(\u0027Get_cdc-events-subscription-key\u0027)","schema":{"properties":{"value":{"type":"string"}},"type":"object"}},"runAfter":{"Get_cdc-events-subscription-key":["Succeeded"]},"type":"ParseJson"},"Parse_cdc-events-token-request-payload":{"inputs":{"content":"@body(\u0027Get_cdc-events-token-request-payload\u0027)","schema":{"properties":{"value":{"type":"string"}},"type":"object"}},"runAfter":{"Get_cdc-events-token-request-payload":["Succeeded"]},"type":"ParseJson"},"Parse_kycloud-api-password":{"inputs":{"content":"@body(\u0027Get_kycloud-api-password_from_KeyVault\u0027)","schema":{"properties":{"value":{"type":"string"}},"type":"object"}},"runAfter":{"Get_kycloud-api-password_from_KeyVault":["Succeeded"]},"type":"ParseJson"},"Parse_kycloud-api-token":{"inputs":{"content":"@body(\u0027Get_kycloud-api-token_from_KeyVault\u0027)","schema":{"properties":{"value":{"type":"string"}},"type":"object"}},"runAfter":{"Get_kycloud-api-token_from_KeyVault":["Succeeded"]},"type":"ParseJson"},"Set-SourceOAUTHKey":{"inputs":{"name":"SourceOAUTHKey","value":"@body(\u0027Parse_kycloud-api-token\u0027)?[\u0027value\u0027]"},"runAfter":{"Parse_kycloud-api-token":["Succeeded"]},"type":"SetVariable"},"Set-SourceOAUTHSecret":{"inputs":{"name":"SourceOAUTHSecret","value":"@body(\u0027Parse_kycloud-api-password\u0027)?[\u0027value\u0027]"},"runAfter":{"Parse_kycloud-api-password":["Succeeded"]},"type":"SetVariable"},"Set-TargetOAUTHCredentials":{"inputs":{"name":"TargetOAUTHCredentials","value":"@body(\u0027Parse_cdc-events-token-request-payload\u0027)?[\u0027value\u0027]"},"runAfter":{"Parse_cdc-events-token-request-payload":["Succeeded"]},"type":"SetVariable"},"Set-TargetOAUTHKey":{"inputs":{"name":"TargetOAUTHKey","value":"@body(\u0027Parse_cdc-events-subscription-key\u0027)?[\u0027value\u0027]"},"runAfter":{"Parse_cdc-events-subscription-key":["Succeeded"]},"type":"SetVariable"}},"runAfter":{"Init-Control-Attachments":["Succeeded"]},"type":"Scope"},"Scope-Report":{"actions":{"If-Control-Status-Success":{"actions":{},"else":{"actions":{"Terminate":{"inputs":{"runError":{"code":"1","message":"Termianted after failure"},"runStatus":"Failed"},"runAfter":{},"type":"Terminate"}}},"expression":{"and":[{"equals":["@variables(\u0027Control-Status\u0027)",100]}]},"runAfter":{},"type":"If"}},"description":"To send notification via email on results of the run.","runAfter":{"Scope-Update-Status-Transform":["Succeeded","TimedOut","Skipped","Failed"]},"type":"Scope"},"Scope-Source-OAUTH":{"actions":{"Get-SourceOAUTHToken":{"inputs":{"headers":{"Accept":"application/json"},"method":"POST","queries":{"ApiToken":"@variables(\u0027SourceOAUTHKey\u0027)","Email":"@parameters(\u0027SourceOAUTHId\u0027)","Password":"@variables(\u0027SourceOAUTHSecret\u0027)"},"uri":"@parameters(\u0027SourceOAUTHEndpoint\u0027)"},"runAfter":{},"type":"Http"},"Parse-SourceOAUTHToken":{"inputs":{"content":"@body(\u0027Get-SourceOAUTHToken\u0027)","schema":{"properties":{"SessionId":{"type":"string"},"Success":{"type":"boolean"}},"type":"object"}},"runAfter":{"Get-SourceOAUTHToken":["Succeeded"]},"type":"ParseJson"},"Validate-SourceOAUTHToken-Request":{"actions":{"Set-SourceOAUTHToken":{"inputs":{"name":"SourceOAUTHToken","value":"@body(\u0027Parse-SourceOAUTHToken\u0027)?[\u0027SessionId\u0027]"},"runAfter":{},"type":"SetVariable"}},"else":{"actions":{"Scope-Source-Error-Fail-SourceOAUTH":{"description":"Throws an error which deflects to last Scope","inputs":{"name":"Control-Error","value":"@int(\u0027__FAIL__\u0027)"},"runAfter":{},"type":"SetVariable"}}},"expression":{"and":[{"equals":["@body(\u0027Parse-SourceOAUTHToken\u0027)?[\u0027Success\u0027]",true]}]},"runAfter":{"Parse-SourceOAUTHToken":["Succeeded"]},"type":"If"}},"runAfter":{"Scope-Update-Status-Source-Login":["Succeeded"]},"type":"Scope"},"Scope-Source-OAUTH-Refresh":{"actions":{"If-Source-OAUTH-Refresh-Success":{"actions":{"If-Parse-Source-OAUTH-Refresh-Token-Success":{"actions":{"Set-SourceOAUTHToken-Again":{"inputs":{"name":"SourceOAUTHToken","value":"@body(\u0027Parse-Source-OAUTH-Refresh\u0027)?[\u0027SessionId\u0027]"},"runAfter":{},"type":"SetVariable"}},"else":{"actions":{"Scope-Source-OAUTH-Refresh-Fail-Parse":{"description":"Throw error because re login parse of data failed","inputs":{"name":"Control-Error","value":"@int(\u0027__FAIL__\u0027)"},"runAfter":{},"type":"SetVariable"}}},"expression":{"and":[{"equals":["@body(\u0027Parse-Source-OAUTH-Refresh\u0027)?[\u0027Success\u0027]",true]}]},"runAfter":{"Parse-Source-OAUTH-Refresh":["Succeeded"]},"type":"If"},"Parse-Source-OAUTH-Refresh":{"inputs":{"content":"@body(\u0027Source-OAUTH-Refresh\u0027)","schema":{"properties":{"SessionId":{"type":"string"},"Success":{"type":"boolean"}},"type":"object"}},"runAfter":{},"type":"ParseJson"}},"else":{"actions":{"Scope-Source-OAUTH-Refresh-Fail-Status":{"description":"Throw and error because the re login failed with bad http status","inputs":{"name":"Control-Error","value":"@int(\u0027__ERROR__\u0027)"},"runAfter":{},"type":"SetVariable"}}},"expression":{"and":[{"equals":["@outputs(\u0027Source-OAUTH-Refresh\u0027)[\u0027statusCode\u0027]",200]}]},"runAfter":{"Source-OAUTH-Refresh":["Succeeded"]},"type":"If"},"Source-OAUTH-Refresh":{"inputs":{"headers":{"Accept":"application/json"},"method":"POST","queries":{"ApiToken":"@variables(\u0027SourceOAUTHKey\u0027)","Email":"@parameters(\u0027SourceOAUTHId\u0027)","Password":"@variables(\u0027SourceOAUTHSecret\u0027)"},"uri":"@parameters(\u0027SourceOAUTHEndpoint\u0027)"},"runAfter":{},"type":"Http"}},"runAfter":{"Scope-Attachments-List":["Succeeded"]},"type":"Scope"},"Scope-Start-Status":{"actions":{"Set-Control-Since":{"description":"Set the Since date and time according to the returned value of the last successful run","inputs":{"name":"Control-Since","value":"@{outputs(\u0027Start\u0027)[\u0027headers\u0027]?[\u0027X-Run-Since\u0027]}"},"runAfter":{"Set-Control-Started":["Succeeded"]},"type":"SetVariable"},"Set-Control-Started":{"description":"Set the started date and time using the returned value to get SQL adjusted milliseconds","inputs":{"name":"Control-Started","value":"@{outputs(\u0027Start\u0027)[\u0027headers\u0027]?[\u0027X-Run-Identifier\u0027]}"},"runAfter":{"Start":["Succeeded"]},"type":"SetVariable"},"Start":{"inputs":{"headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/json","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)"},"method":"POST","uri":"@parameters(\u0027TargetControlEndpoint\u0027)"},"runAfter":{},"type":"Http"}},"runAfter":{"Scope-Target-OAUTH":["Succeeded"]},"type":"Scope"},"Scope-Target-OAUTH":{"actions":{"Get_CDC_Events_OAuth_Token":{"inputs":{"body":"@variables(\u0027TargetOAUTHCredentials\u0027)","headers":{"Content-Type":"application/x-www-form-urlencoded"},"method":"POST","uri":"@parameters(\u0027TargetOAUTHEndpoint\u0027)"},"runAfter":{},"type":"Http"},"Parse_CDC_Events_OAuth_Token":{"inputs":{"content":"@body(\u0027Get_CDC_Events_OAuth_Token\u0027)","schema":{"properties":{"access_token":{"type":"string"}},"type":"object"}},"runAfter":{"Get_CDC_Events_OAuth_Token":["Succeeded"]},"type":"ParseJson"},"Set-TargetOAUTHToken":{"inputs":{"name":"TargetOAUTHToken","value":"@body(\u0027Parse_CDC_Events_OAuth_Token\u0027)?[\u0027access_token\u0027]"},"runAfter":{"Parse_CDC_Events_OAuth_Token":["Succeeded"]},"type":"SetVariable"}},"runAfter":{"Scope-Get-Secrets":["Succeeded"]},"type":"Scope"},"Scope-Update-Status-Entities":{"actions":{"Record-Control-Status-Entities":{"inputs":{"headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/json","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)","X-Run-Status":"@{variables(\u0027Control-Status\u0027)}"},"method":"PATCH","uri":"@parameters(\u0027TargetControlEndpoint\u0027)"},"runAfter":{"Set-Control-Status-Entities":["Succeeded"]},"type":"Http"},"Set-Control-Status-Entities":{"inputs":{"name":"Control-Status","value":8},"runAfter":{},"type":"SetVariable"}},"runAfter":{"Scope-Source-OAUTH":["Succeeded"]},"type":"Scope"},"Scope-Update-Status-Extract":{"actions":{"Record-Control-Status-Extract":{"inputs":{"headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/json","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)","X-Run-Status":"@{variables(\u0027Control-Status\u0027)}"},"method":"PUT","uri":"@parameters(\u0027TargetControlEndpoint\u0027)"},"runAfter":{"Set-Control-Status-Extract":["Succeeded"]},"type":"Http"},"Set-Control-Status-Extract":{"inputs":{"name":"Control-Status","value":32},"runAfter":{},"type":"SetVariable"}},"runAfter":{"Scope-Entities":["Succeeded"]},"type":"Scope"},"Scope-Update-Status-Preparing":{"actions":{"Record-Control-Status-Preparing":{"inputs":{"headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/json","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)","X-Run-Status":"@{variables(\u0027Control-Status\u0027)}"},"method":"PATCH","uri":"@parameters(\u0027TargetControlEndpoint\u0027)"},"runAfter":{"Set-Control-Status-Preparing":["Succeeded"]},"type":"Http"},"Set-Control-Status-Preparing":{"inputs":{"name":"Control-Status","value":2},"runAfter":{},"type":"SetVariable"}},"runAfter":{"Scope-Start-Status":["Succeeded"]},"type":"Scope"},"Scope-Update-Status-Source-Login":{"actions":{"Record-Control-Status-Source-Login":{"inputs":{"headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/json","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)","X-Run-Status":"@{variables(\u0027Control-Status\u0027)}"},"method":"PATCH","uri":"@parameters(\u0027TargetControlEndpoint\u0027)"},"runAfter":{"Set-Control-Status-Source-Login":["Succeeded"]},"type":"Http"},"Set-Control-Status-Source-Login":{"inputs":{"name":"Control-Status","value":4},"runAfter":{},"type":"SetVariable"}},"runAfter":{"Scope-Update-Status-Preparing":["Succeeded"]},"type":"Scope"},"Scope-Update-Status-Transform":{"actions":{"Condition":{"actions":{},"else":{"actions":{"Scope-Update-Status-Transform-Fail":{"inputs":{"name":"Control-Error","value":"@int(\u0027__ERROR__\u0027)"},"runAfter":{},"type":"SetVariable"}}},"expression":{"and":[{"equals":["@outputs(\u0027Record-Control-Status-Transform\u0027)[\u0027statusCode\u0027]",202]}]},"runAfter":{"Record-Control-Status-Transform":["Succeeded"]},"type":"If"},"Record-Control-Status-Transform":{"inputs":{"headers":{"Authorization":"Bearer @{variables(\u0027TargetOAUTHToken\u0027)}","Content-Type":"application/json","Ocp-Apim-Subscription-Key":"@variables(\u0027TargetOAUTHKey\u0027)","X-Run-Identifier":"@variables(\u0027Control-Started\u0027)","X-Run-Status":"@{variables(\u0027Control-Status\u0027)}"},"method":"PUT","uri":"@parameters(\u0027TargetControlEndpoint\u0027)"},"runAfter":{"Set-Control-Status-Transform":["Succeeded"]},"type":"Http"},"Set-Control-Status-Report-Success":{"inputs":{"name":"Control-Status","value":100},"runAfter":{"Condition":["Succeeded"]},"type":"SetVariable"},"Set-Control-Status-Transform":{"inputs":{"name":"Control-Status","value":64},"runAfter":{},"type":"SetVariable"}},"description":"Complete the run and trigger the transformation of the changes","runAfter":{"Scope-Attachments":["Succeeded"]},"type":"Scope"}},"contentVersion":"1.0.0.0","parameters":{"SecretsAudience":{"defaultValue":"https://vault.azure.net","type":"String"},"SourceEndpoint":{"defaultValue":"[variables(\u0027dataPathUri\u0027)]","type":"String"},"SourceEntities":{"defaultValue":["users","portfolios","sites","surveys","surveysections","surveysectionelements","deleted"],"type":"Array"},"SourceOAUTHEndpoint":{"defaultValue":"[variables(\u0027loginUri\u0027)]","type":"String"},"SourceOAUTHId":{"defaultValue":"[parameters(\u0027kycloudApiEmail\u0027)]","type":"String"},"SourceOAUTHKeyUri":{"defaultValue":"[variables(\u0027keyVaultSecretKycloudApiToken\u0027)]","type":"String"},"SourceOAUTHSecretUri":{"defaultValue":"[variables(\u0027keyVaultSecretKycloudApiPassword\u0027)]","type":"String"},"TargetControlEndpoint":{"defaultValue":"[concat(variables(\u0027dataPathUri\u0027),\u0027/\u0027,\u0027load\u0027)]","type":"String"},"TargetEndpoint":{"defaultValue":"[variables(\u0027dataPathUri\u0027)]","type":"String"},"TargetOAUTHCredentialsUri":{"defaultValue":"[variables(\u0027keyVaultSecretCdcEventsTokenRequestPayload\u0027)]","type":"String"},"TargetOAUTHEndpoint":{"defaultValue":"[variables(\u0027[parameters(\u0027internalOAuthTokenEndpoint\u0027)]\u0027)]","type":"String"},"TargetOAUTHKeyUri":{"defaultValue":"[variables(\u0027keyVaultSecretCdcEventsSubscriptionKey\u0027)]","type":"String"}},"triggers":{"Recurrence":{"recurrence":{"frequency":"Day","interval":1,"schedule":{"hours":["0"]}},"type":"Recurrence"}}},"parameters":{}}}],"outputs":{"logicAppPrincipalId":{"value":"[reference(variables(\u0027logicAppId\u0027), \u00272019-05-01\u0027, \u0027Full\u0027).identity.principalId]","type":"string"}},"contentVersion":"1.0.0.0"}
