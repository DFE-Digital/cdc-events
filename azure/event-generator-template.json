{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "parameters": {
    "serviceIdentifier": {
      "type": "string",
      "minLength": 4,
      "maxLength": 4
    },
    "environment": {
      "type": "string",
      "defaultValue": "d",
      "allowedValues": [ "d", "t", "p" ]
    },
    "environmentName": {
      "type": "string",
      "defaultValue": "DEV",
      "allowedValues": [ "DEV", "TEST", "OAT", "PROD" ]
    },
    "environmentInstance": {
      "type": "string",
      "minLength": 2,
      "maxLength": 2,
      "defaultValue": "01"
    },
    "sharedResourcesAppName": {
      "type": "string",
      "defaultValue": "common"
    },
    "eapimPublicIpAddress": { "type": "string" },
    "keyVaultInstance": {
      "type": "string",
      "minLength": 2,
      "maxLength": 2,
      "defaultValue": "01"
    },
    "keyVaultSecretNameCdcEventsSubscriptionKey": {
      "type": "string",
      "defaultValue": "cdc-events-subscription-key"
    },
    "keyVaultSecretNameKycloudApiPassword": {
      "type": "string",
      "defaultValue": "kycloud-api-password"
    },
    "keyVaultSecretNameKycloudApiToken": {
      "type": "string",
      "defaultValue": "kycloud-api-token"
    },
    "keyVaultSecretNameCdcEventsTokenRequestPayload": {
      "type": "string",
      "defaultValue": "cdc-events-token-request-payload"
    },
    "cdcEventsApiBaseUri": { "type": "string" },
    "kycloudApiBaseUri": { "type": "string" },
    "kycloudApiEmail": { "type": "string" },
    "loginEndpoint": {
      "type": "string",
      "defaultValue": "user/login"
    },
    "dataPathPrefix": {
      "type": "string",
      "defaultValue": "data"
    },
    "internalOAuthTokenEndpoint": { "type": "string" },
    "appName": {
      "type": "string",
      "defaultValue": "cdcaeg"
    },
    "appInstance": {
      "type": "string",
      "defaultValue": "01"
    }
  },
  "variables": {
    "singleQuote": "'",
    "namePrefix": "[concat(parameters('serviceIdentifier'), parameters('environment'), parameters('environmentInstance'))]",
    "sharedResourceGroupName": "[concat(variables('namePrefix'), '-', parameters('sharedResourcesAppName'))]",
    "keyVaultName": "[concat(variables('namePrefix'), '-kv-', parameters('keyVaultInstance'))]",
    "logicAppName": "[concat(variables('namePrefix'), '-', parameters('appName'), '-la-', parameters('appInstance'))]",
    "logicAppId": "[resourceId('Microsoft.Logic/workflows/', variables('logicAppName'))]",
    "keyVaultSecretCdcEventsSubscriptionKey": "[resourceId(variables('sharedResourceGroupName'), 'Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), parameters('keyVaultSecretNameCdcEventsSubscriptionKey'))]",
    "keyVaultSecretKycloudApiPassword": "[resourceId(variables('sharedResourceGroupName'), 'Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), parameters('keyVaultSecretNameKycloudApiPassword'))]",
    "keyVaultSecretKycloudApiToken": "[resourceId(variables('sharedResourceGroupName'), 'Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), parameters('keyVaultSecretNameKycloudApiToken'))]",
    "keyVaultSecretCdcEventsTokenRequestPayload": "[resourceId(variables('sharedResourceGroupName'), 'Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), parameters('keyVaultSecretNameCdcEventsTokenRequestPayload'))]",
    "loginUri": "[concat(parameters('kycloudApiBaseUri'), '/', parameters('loginEndpoint'))]",
    "dataPathUri": "[concat(parameters('kycloudApiBaseUri'), '/', parameters('dataPathPrefix'))]"
  },
  "resources": [
    {
      "apiVersion": "2017-07-01",
      "type": "Microsoft.Logic/workflows",
      "name": "[variables('logicAppName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "environment": "[parameters('environmentName')]",
        "app": "[parameters('appName')]"
      },
      "identity": { "type": "SystemAssigned" },
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Init-Control-Attachments": {
              "description": "The received collection of attachments to obtain",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Attachments",
                    "type": "array",
                    "value": []
                  }
                ]
              },
              "runAfter": { "Init-SourceOAUTHToken": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-Control-Continue": {
              "description": "Control variable to control continuation within the task following issues",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Continue",
                    "type": "boolean",
                    "value": "@true"
                  }
                ]
              },
              "runAfter": { "Init-Control-Continue-Step": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-Control-Continue-Step": {
              "description": "Control variable to control continuation within a step following issues",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Continue-Step",
                    "type": "boolean",
                    "value": "@true"
                  }
                ]
              },
              "runAfter": { "Init-Control-Since": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-Control-Error": {
              "description": "A variable used in throw errors to stop processing",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Error",
                    "type": "integer",
                    "value": 0
                  }
                ]
              },
              "runAfter": { "Init-Control-Status": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-Control-Error-Message": {
              "description": "A variable used to describe the current problem",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Error-Message",
                    "type": "string",
                    "value": "@{null}"
                  }
                ]
              },
              "runAfter": { "Init-Control-Error": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-Control-Page": {
              "description": "Control variable to control pagination within an entity download",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Page",
                    "type": "integer",
                    "value": 1
                  }
                ]
              },
              "runAfter": { "Init-Control-Continue": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-Control-Since": {
              "description": "Fundamental control property which controls scope of data delta's received from source",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Since",
                    "type": "string",
                    "value": "@{null}"
                  }
                ]
              },
              "runAfter": { "Init-Control-Started": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-Control-Started": {
              "description": "Fundamental control property and key to process control",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Started",
                    "type": "string",
                    "value": "@{utcNow()}"
                  }
                ]
              },
              "runAfter": { "Init-Control-Error-Message": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-Control-Status": {
              "description": "The task control status recorded in the database by target APIP calls",
              "inputs": {
                "variables": [
                  {
                    "name": "Control-Status",
                    "type": "integer",
                    "value": 1
                  }
                ]
              },
              "runAfter": {},
              "type": "InitializeVariable"
            },
            "Init-SourceOAUTHKey": {
              "description": "The source OAUTH (or not) key",
              "inputs": {
                "variables": [
                  {
                    "name": "SourceOAUTHKey",
                    "type": "string",
                    "value": "@{null}"
                  }
                ]
              },
              "runAfter": { "Init-Control-Page": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-SourceOAUTHSecret": {
              "description": "The source OAUTH Secret or password",
              "inputs": {
                "variables": [
                  {
                    "name": "SourceOAUTHSecret",
                    "type": "string",
                    "value": "@{null}"
                  }
                ]
              },
              "runAfter": { "Init-SourceOAUTHKey": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-SourceOAUTHToken": {
              "description": "The received source OAUTH token",
              "inputs": {
                "variables": [
                  {
                    "name": "SourceOAUTHToken",
                    "type": "string",
                    "value": "@{null}"
                  }
                ]
              },
              "runAfter": { "Init-TargetOAUTHToken": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-TargetOAUTHCredentials": {
              "description": "The target OAUTH Credentials of id and secret",
              "inputs": {
                "variables": [
                  {
                    "name": "TargetOAUTHCredentials",
                    "type": "string",
                    "value": "@{null}"
                  }
                ]
              },
              "runAfter": { "Init-TargetOAUTHKey": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-TargetOAUTHKey": {
              "description": "The target OAUTH key",
              "inputs": {
                "variables": [
                  {
                    "name": "TargetOAUTHKey",
                    "type": "string",
                    "value": "@{null}"
                  }
                ]
              },
              "runAfter": { "Init-SourceOAUTHSecret": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Init-TargetOAUTHToken": {
              "description": "The received target OAUTH token",
              "inputs": {
                "variables": [
                  {
                    "name": "TargetOAUTHToken",
                    "type": "string",
                    "value": "@{null}"
                  }
                ]
              },
              "runAfter": { "Init-TargetOAUTHCredentials": [ "Succeeded" ] },
              "type": "InitializeVariable"
            },
            "Scope-Attachments": {
              "actions": {
                "For_each_attachment": {
                  "actions": {
                    "If-Post-Blob-Success": {
                      "actions": {},
                      "else": {
                        "actions": {
                          "Scope-Attachments-Fail-Post-To-Target": {
                            "description": "Throw error to exit scope and fail run - should really check for 401 and attempt re login to target",
                            "inputs": {
                              "name": "Control-Error",
                              "value": "@int('__ERROR_')"
                            },
                            "runAfter": { "Set_variable": [ "Succeeded" ] },
                            "type": "SetVariable"
                          },
                          "Set_variable": {
                            "inputs": {
                              "name": "Control-Error-Message",
                              "value": "Failed to post blob data"
                            },
                            "runAfter": {},
                            "type": "SetVariable"
                          }
                        }
                      },
                      "expression": { "and": [ { "equals": [ "@outputs('Post-blob')['statusCode']", 202 ] } ] },
                      "runAfter": { "Post-blob": [ "Succeeded" ] },
                      "type": "If"
                    },
                    "Post-blob": {
                      "inputs": {
                        "body": [
                          {
                            "BlobData": "@body('Get-Blob')",
                            "BlobFilename": "@{items('For_each_attachment')['BlobKey']}@{items('For_each_attachment')['Extension']}",
                            "BlobFolder": "@{items('For_each_attachment')['Folder']}",
                            "BlobKey": "@items('For_each_attachment')['BlobKey']",
                            "BlobMimeType": "@items('For_each_attachment')['MimeType']",
                            "BlobObtained": "@variables('Control-Started')",
                            "BlobShare": "cdcdocuments",
                            "BlobSiteUniqueId": "@items('For_each_attachment')?['SiteUniqueId']"
                          }
                        ],
                        "headers": {
                          "Authorization": "Bearer @{variables('TargetOAUTHToken')}",
                          "Content-Type": "application/octet-stream",
                          "Ocp-Apim-Subscription-Key": "@variables('TargetOAUTHKey')",
                          "X-Run-Identifier": "@variables('Control-Started')"
                        },
                        "method": "POST",
                        "uri": "@{parameters('TargetEndpoint')}blobs"
                      },
                      "runAfter": { "While-Control-Continue-Step-True": [ "Succeeded" ] },
                      "runtimeConfiguration": { "contentTransfer": { "transferMode": "Chunked" } },
                      "type": "Http"
                    },
                    "While-Control-Continue-Step-True": {
                      "actions": {
                        "Get-Blob": {
                          "inputs": {
                            "headers": { "Accept": "*/*" },
                            "method": "GET",
                            "queries": {
                              "AsAtachment": "true",
                              "AsAttachment": "true",
                              "BlobKey": "@items('For_each_attachment')['BlobKey']",
                              "SessionId": "@variables('SourceOAUTHToken')"
                            },
                            "uri": "@{parameters('SourceEndpoint')}blobs"
                          },
                          "runAfter": {},
                          "type": "Http"
                        },
                        "If-Get-Blob-Success": {
                          "actions": {},
                          "else": {
                            "actions": {
                              "If-Unauthorised": {
                                "actions": {
                                  "Parse_relogin_after_401": {
                                    "inputs": {
                                      "content": "@body('Re_login_after_401')",
                                      "schema": {
                                        "properties": {
                                          "SessionId": { "type": "string" },
                                          "Success": { "type": "boolean" }
                                        },
                                        "type": "object"
                                      }
                                    },
                                    "runAfter": { "Re_login_after_401": [ "Succeeded" ] },
                                    "type": "ParseJson"
                                  },
                                  "Re_login_after_401": {
                                    "inputs": {
                                      "headers": { "Accept": "application/json" },
                                      "method": "POST",
                                      "queries": {
                                        "ApiToken": "@variables('SourceOAUTHToken')",
                                        "Email": "@parameters('KycloudApiEmail')",
                                        "Password": "@variables('SourceOAUTHSecret')"
                                      },
                                      "uri": "@parameters('SourceOAUTHEndpoint')"
                                    },
                                    "runAfter": {},
                                    "type": "Http"
                                  },
                                  "Set_AttachementsSessionId_after_relogin_after_401": {
                                    "inputs": {
                                      "name": "SourceOAUTHToken",
                                      "value": "@body('Parse_relogin_after_401')?['SessionId']"
                                    },
                                    "runAfter": { "Parse_relogin_after_401": [ "Succeeded" ] },
                                    "type": "SetVariable"
                                  }
                                },
                                "else": {
                                  "actions": {
                                    "Set-Control-Continue-Step-False": {
                                      "inputs": {
                                        "name": "Control-Continue-Step",
                                        "value": "@false"
                                      },
                                      "runAfter": {},
                                      "type": "SetVariable"
                                    },
                                    "Set-Control-Error-Get-Blob-Error": {
                                      "inputs": {
                                        "name": "Control-Error",
                                        "value": "@int('__EROR__')"
                                      },
                                      "runAfter": { "Set-Control-Continue-Step-False": [ "Succeeded" ] },
                                      "type": "SetVariable"
                                    }
                                  }
                                },
                                "expression": { "and": [ { "equals": [ "", 401 ] } ] },
                                "runAfter": {},
                                "type": "If"
                              }
                            }
                          },
                          "expression": { "and": [ { "equals": [ "@outputs('Get-Blob')['statusCode']", 200 ] } ] },
                          "runAfter": { "Get-Blob": [ "Succeeded" ] },
                          "type": "If"
                        }
                      },
                      "expression": { "and": [ { "equals": [ "@variables('Control-Continue-Step')", "@true" ] } ] },
                      "runAfter": {},
                      "type": "If"
                    }
                  },
                  "foreach": "@variables('Control-Attachments')",
                  "runAfter": {},
                  "type": "Foreach"
                }
              },
              "description": "Obtain all of the attachments on the list and post the data and metadata to the blobs endpoint to store the file and update the database.",
              "runAfter": { "Scope-Source-OAUTH-Refresh": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Attachments-List": {
              "actions": {
                "Get-Attachments-List": {
                  "inputs": {
                    "headers": {
                      "Authorization": "Bearer @{variables('TargetOAUTHToken')}",
                      "Content-Type": "application/json",
                      "Ocp-Apim-Subscription-Key": "@variables('TargetOAUTHKey')",
                      "X-Run-Identifier": "@variables('Control-Started')"
                    },
                    "method": "GET",
                    "uri": "@{parameters('TargetEndpoint')}attachments"
                  },
                  "runAfter": {},
                  "type": "Http"
                },
                "Parse-Attachments-List": {
                  "inputs": {
                    "content": "@body('Get-Attachments-List')",
                    "schema": {
                      "items": {
                        "properties": {
                          "BlobKey": { "type": "string" },
                          "Extension": { "type": "string" },
                          "Folder": { "type": "string" },
                          "MimeType": { "type": "string" },
                          "SiteUniqueId": { "type": "string" }
                        },
                        "required": [ "BlobKey", "MimeType", "Extension", "Folder", "SiteUniqueId" ],
                        "type": "object"
                      },
                      "type": "array"
                    }
                  },
                  "runAfter": { "Get-Attachments-List": [ "Succeeded" ] },
                  "type": "ParseJson"
                },
                "Set-Control-Attachments-List": {
                  "inputs": {
                    "name": "Control-Attachments",
                    "value": "@body('Parse-Attachments-List')"
                  },
                  "runAfter": { "Parse-Attachments-List": [ "Succeeded" ] },
                  "type": "SetVariable"
                }
              },
              "runAfter": { "Scope-Update-Status-Extract": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Entities": {
              "actions": {
                "For_each_ApiEntitiesToPull": {
                  "actions": {
                    "Loop_through_pages": {
                      "actions": {
                        "Get-Entity-Page": {
                          "inputs": {
                            "headers": { "Accept": "application/json" },
                            "method": "GET",
                            "queries": {
                              "Page": "@{variables('Control-Page')}",
                              "PageSize": "1000",
                              "SessionId": "@variables('SourceOAUTHToken')",
                              "UpdatedSince": "@variables('Control-Since')",
                              "format": "json",
                              "jsconfig": "dh:iso8601"
                            },
                            "retryPolicy": { "type": "none" },
                            "uri": "@{parameters('SourceEndpoint')}@{items('For_each_ApiEntitiesToPull')}"
                          },
                          "runAfter": {},
                          "type": "Http"
                        },
                        "If-Entities-Received": {
                          "actions": {
                            "Post-Entity-Page": {
                              "inputs": {
                                "body": "@body('Parse-Entity-Page')?['Infos']",
                                "headers": {
                                  "Authorization": "Bearer @{variables('TargetOAUTHToken')}",
                                  "Content-Type": "application/octet-stream",
                                  "Ocp-Apim-Subscription-Key": "@variables('TargetOAUTHKey')",
                                  "X-Page": "@{variables('Control-Page')}",
                                  "X-Run-Identifier": "@variables('Control-Started')"
                                },
                                "method": "POST",
                                "retryPolicy": { "type": "none" },
                                "uri": "@{parameters('TargetEndpoint')}@{items('For_each_ApiEntitiesToPull')}"
                              },
                              "runAfter": {},
                              "type": "Http"
                            }
                          },
                          "else": {
                            "actions": {
                              "Set-Control-Continue-False": {
                                "inputs": {
                                  "name": "Control-Continue",
                                  "value": "@false"
                                },
                                "runAfter": {},
                                "type": "SetVariable"
                              }
                            }
                          },
                          "expression": { "and": [ { "greater": [ "@length(body('Parse-Entity-Page')['Infos'])", 0 ] } ] },
                          "runAfter": { "Increment-Control-Page": [ "Succeeded" ] },
                          "type": "If"
                        },
                        "Increment-Control-Page": {
                          "inputs": {
                            "name": "Control-Page",
                            "value": 1
                          },
                          "runAfter": { "Parse-Entity-Page": [ "Succeeded" ] },
                          "type": "IncrementVariable"
                        },
                        "Parse-Entity-Page": {
                          "inputs": {
                            "content": "@body('Get-Entity-Page')",
                            "schema": {
                              "properties": {
                                "Infos": {
                                  "items": { "type": "object" },
                                  "type": "array"
                                },
                                "Success": { "type": "boolean" }
                              },
                              "type": "object"
                            }
                          },
                          "runAfter": { "Get-Entity-Page": [ "Succeeded" ] },
                          "type": "ParseJson"
                        }
                      },
                      "expression": "@equals(variables('Control-Continue'), false)",
                      "limit": {
                        "count": 5000,
                        "timeout": "PT1H"
                      },
                      "runAfter": { "Set-Control-Page-1": [ "Succeeded" ] },
                      "type": "Until"
                    },
                    "Set-Control-Continue-True": {
                      "inputs": {
                        "name": "Control-Continue",
                        "value": "@true"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    },
                    "Set-Control-Page-1": {
                      "inputs": {
                        "name": "Control-Page",
                        "value": 1
                      },
                      "runAfter": { "Set-Control-Continue-True": [ "Succeeded" ] },
                      "type": "SetVariable"
                    }
                  },
                  "foreach": "@parameters('SourceEntities')",
                  "runAfter": {},
                  "runtimeConfiguration": { "concurrency": { "repetitions": 1 } },
                  "type": "Foreach"
                }
              },
              "runAfter": { "Scope-Update-Status-Entities": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Get-Secrets": {
              "actions": {
                "Get_cdc-events-subscription-key": {
                  "inputs": {
                    "authentication": {
                      "audience": "@parameters('SecretsAudience')",
                      "type": "ManagedServiceIdentity"
                    },
                    "method": "GET",
                    "uri": "@parameters('TargetOAUTHKeyUri')"
                  },
                  "runAfter": { "Set-SourceOAUTHSecret": [ "Succeeded" ] },
                  "type": "Http"
                },
                "Get_cdc-events-token-request-payload": {
                  "inputs": {
                    "authentication": {
                      "audience": "@parameters('SecretsAudience')",
                      "type": "ManagedServiceIdentity"
                    },
                    "method": "GET",
                    "uri": "@parameters('TargetOAUTHCredentialsUri')"
                  },
                  "runAfter": { "Set-TargetOAUTHKey": [ "Succeeded" ] },
                  "type": "Http"
                },
                "Get_kycloud-api-password_from_KeyVault": {
                  "inputs": {
                    "authentication": {
                      "audience": "@parameters('SecretsAudience')",
                      "type": "ManagedServiceIdentity"
                    },
                    "method": "GET",
                    "uri": "@parameters('SourceOAUTHSecretUri')"
                  },
                  "runAfter": { "Set-SourceOAUTHKey": [ "Succeeded" ] },
                  "type": "Http"
                },
                "Get_kycloud-api-token_from_KeyVault": {
                  "inputs": {
                    "authentication": {
                      "audience": "@parameters('SecretsAudience')",
                      "type": "ManagedServiceIdentity"
                    },
                    "method": "GET",
                    "uri": "@parameters('SourceOAUTHKeyUri')"
                  },
                  "runAfter": {},
                  "type": "Http"
                },
                "Parse_cdc-events-subscription-key": {
                  "inputs": {
                    "content": "@body('Get_cdc-events-subscription-key')",
                    "schema": {
                      "properties": { "value": { "type": "string" } },
                      "type": "object"
                    }
                  },
                  "runAfter": { "Get_cdc-events-subscription-key": [ "Succeeded" ] },
                  "type": "ParseJson"
                },
                "Parse_cdc-events-token-request-payload": {
                  "inputs": {
                    "content": "@body('Get_cdc-events-token-request-payload')",
                    "schema": {
                      "properties": { "value": { "type": "string" } },
                      "type": "object"
                    }
                  },
                  "runAfter": { "Get_cdc-events-token-request-payload": [ "Succeeded" ] },
                  "type": "ParseJson"
                },
                "Parse_kycloud-api-password": {
                  "inputs": {
                    "content": "@body('Get_kycloud-api-password_from_KeyVault')",
                    "schema": {
                      "properties": { "value": { "type": "string" } },
                      "type": "object"
                    }
                  },
                  "runAfter": { "Get_kycloud-api-password_from_KeyVault": [ "Succeeded" ] },
                  "type": "ParseJson"
                },
                "Parse_kycloud-api-token": {
                  "inputs": {
                    "content": "@body('Get_kycloud-api-token_from_KeyVault')",
                    "schema": {
                      "properties": { "value": { "type": "string" } },
                      "type": "object"
                    }
                  },
                  "runAfter": { "Get_kycloud-api-token_from_KeyVault": [ "Succeeded" ] },
                  "type": "ParseJson"
                },
                "Set-SourceOAUTHKey": {
                  "inputs": {
                    "name": "SourceOAUTHKey",
                    "value": "@body('Parse_kycloud-api-token')?['value']"
                  },
                  "runAfter": { "Parse_kycloud-api-token": [ "Succeeded" ] },
                  "type": "SetVariable"
                },
                "Set-SourceOAUTHSecret": {
                  "inputs": {
                    "name": "SourceOAUTHSecret",
                    "value": "@body('Parse_kycloud-api-password')?['value']"
                  },
                  "runAfter": { "Parse_kycloud-api-password": [ "Succeeded" ] },
                  "type": "SetVariable"
                },
                "Set-TargetOAUTHCredentials": {
                  "inputs": {
                    "name": "TargetOAUTHCredentials",
                    "value": "@body('Parse_cdc-events-token-request-payload')?['value']"
                  },
                  "runAfter": { "Parse_cdc-events-token-request-payload": [ "Succeeded" ] },
                  "type": "SetVariable"
                },
                "Set-TargetOAUTHKey": {
                  "inputs": {
                    "name": "TargetOAUTHKey",
                    "value": "@body('Parse_cdc-events-subscription-key')?['value']"
                  },
                  "runAfter": { "Parse_cdc-events-subscription-key": [ "Succeeded" ] },
                  "type": "SetVariable"
                },
                "Validate-Secrets": {
                  "actions": {},
                  "else": {
                    "actions": {
                      "Scope-Get-Secrets-Fail": {
                        "inputs": {
                          "name": "Control-Error",
                          "value": "@int('__ERROR__')"
                        },
                        "runAfter": { "Scope-Get-Secrets-Fail-Message": [ "Succeeded" ] },
                        "type": "SetVariable"
                      },
                      "Scope-Get-Secrets-Fail-Message": {
                        "inputs": {
                          "name": "Control-Error-Message",
                          "value": "Unable to obtain required Secrets"
                        },
                        "runAfter": {},
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      { "not": { "equals": [ "@variables('SourceOAUTHKey')", "@null" ] } },
                      { "not": { "equals": [ "@variables('SourceOAUTHSecret')", "" ] } },
                      { "not": { "equals": [ "@variables('TargetOAUTHKey')", "" ] } },
                      { "not": { "equals": [ "@variables('TargetOAUTHCredentials')", "" ] } }
                    ]
                  },
                  "runAfter": { "Set-TargetOAUTHCredentials": [ "Succeeded" ] },
                  "type": "If"
                }
              },
              "runAfter": { "Init-Control-Attachments": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Report": {
              "actions": {
                "If-Control-Status-Success": {
                  "actions": {},
                  "else": {
                    "actions": {
                      "Terminate": {
                        "inputs": {
                          "runError": {
                            "code": "1",
                            "message": "Termianted after failure"
                          },
                          "runStatus": "Failed"
                        },
                        "runAfter": {},
                        "type": "Terminate"
                      }
                    }
                  },
                  "expression": { "and": [ { "equals": [ "@variables('Control-Status')", "@parameters('StatusReporting')" ] } ] },
                  "runAfter": {},
                  "type": "If"
                }
              },
              "description": "To send notification via email on results of the run.",
              "runAfter": { "Scope-Update-Status-Transform": [ "Succeeded", "TimedOut", "Skipped", "Failed" ] },
              "type": "Scope"
            },
            "Scope-Source-OAUTH": {
              "actions": {
                "Get-SourceOAUTHToken": {
                  "description": "Perform a login API call to the source data provider",
                  "inputs": {
                    "headers": { "Accept": "application/json" },
                    "method": "POST",
                    "queries": {
                      "ApiToken": "@variables('SourceOAUTHKey')",
                      "Email": "@parameters('SourceOAUTHId')",
                      "Password": "@variables('SourceOAUTHSecret')"
                    },
                    "uri": "@parameters('SourceOAUTHEndpoint')"
                  },
                  "runAfter": {},
                  "type": "Http"
                },
                "Parse-SourceOAUTHToken": {
                  "inputs": {
                    "content": "@body('Get-SourceOAUTHToken')",
                    "schema": {
                      "properties": {
                        "SessionId": { "type": "string" },
                        "Success": { "type": "boolean" }
                      },
                      "type": "object"
                    }
                  },
                  "runAfter": { "Get-SourceOAUTHToken": [ "Succeeded" ] },
                  "type": "ParseJson"
                },
                "Validate-SourceOAUTHToken-Request": {
                  "actions": {
                    "Set-SourceOAUTHToken": {
                      "inputs": {
                        "name": "SourceOAUTHToken",
                        "value": "@body('Parse-SourceOAUTHToken')?['SessionId']"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "Scope-Source-Error-Fail-SourceOAUTH": {
                        "description": "Throws an error which deflects to last Scope",
                        "inputs": {
                          "name": "Control-Error",
                          "value": "@int('__FAIL__')"
                        },
                        "runAfter": {},
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": { "and": [ { "equals": [ "@body('Parse-SourceOAUTHToken')?['Success']", true ] } ] },
                  "runAfter": { "Parse-SourceOAUTHToken": [ "Succeeded" ] },
                  "type": "If"
                }
              },
              "runAfter": { "Scope-Update-Status-Source-Login": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Source-OAUTH-Refresh": {
              "actions": {
                "If-Source-OAUTH-Refresh-Success": {
                  "actions": {
                    "If-Parse-Source-OAUTH-Refresh-Token-Success": {
                      "actions": {
                        "Set-SourceOAUTHToken-Again": {
                          "inputs": {
                            "name": "SourceOAUTHToken",
                            "value": "@body('Parse-Source-OAUTH-Refresh')?['SessionId']"
                          },
                          "runAfter": {},
                          "type": "SetVariable"
                        }
                      },
                      "else": {
                        "actions": {
                          "Scope-Source-OAUTH-Refresh-Fail-Parse": {
                            "description": "Throw error because re login parse of data failed",
                            "inputs": {
                              "name": "Control-Error",
                              "value": "@int('__FAIL__')"
                            },
                            "runAfter": {},
                            "type": "SetVariable"
                          }
                        }
                      },
                      "expression": { "and": [ { "equals": [ "@body('Parse-Source-OAUTH-Refresh')?['Success']", true ] } ] },
                      "runAfter": { "Parse-Source-OAUTH-Refresh": [ "Succeeded" ] },
                      "type": "If"
                    },
                    "Parse-Source-OAUTH-Refresh": {
                      "inputs": {
                        "content": "@body('Source-OAUTH-Refresh')",
                        "schema": {
                          "properties": {
                            "SessionId": { "type": "string" },
                            "Success": { "type": "boolean" }
                          },
                          "type": "object"
                        }
                      },
                      "runAfter": {},
                      "type": "ParseJson"
                    }
                  },
                  "else": {
                    "actions": {
                      "Scope-Source-OAUTH-Refresh-Fail-Status": {
                        "description": "Throw and error because the re login failed with bad http status",
                        "inputs": {
                          "name": "Control-Error",
                          "value": "@int('__ERROR__')"
                        },
                        "runAfter": {},
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": { "and": [ { "equals": [ "@outputs('Source-OAUTH-Refresh')['statusCode']", 200 ] } ] },
                  "runAfter": { "Source-OAUTH-Refresh": [ "Succeeded" ] },
                  "type": "If"
                },
                "Source-OAUTH-Refresh": {
                  "inputs": {
                    "headers": { "Accept": "application/json" },
                    "method": "POST",
                    "queries": {
                      "ApiToken": "@variables('SourceOAUTHKey')",
                      "Email": "@parameters('SourceOAUTHId')",
                      "Password": "@variables('SourceOAUTHSecret')"
                    },
                    "uri": "@parameters('SourceOAUTHEndpoint')"
                  },
                  "runAfter": {},
                  "type": "Http"
                }
              },
              "runAfter": { "Scope-Attachments-List": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Start-Status": {
              "actions": {
                "Record-Control-Status-Start": {
                  "inputs": {
                    "headers": {
                      "Authorization": "Bearer @{variables('TargetOAUTHToken')}",
                      "Content-Type": "application/json",
                      "Ocp-Apim-Subscription-Key": "@variables('TargetOAUTHKey')",
                      "X-Run-Identifier": "@variables('Control-Started')"
                    },
                    "method": "POST",
                    "uri": "@parameters('TargetControlEndpoint')"
                  },
                  "runAfter": {},
                  "type": "Http"
                },
                "Set-Control-Since": {
                  "description": "Set the Since date and time according to the returned value of the last successful run",
                  "inputs": {
                    "name": "Control-Since",
                    "value": "@{outputs('Record-Control-Status-Start')['headers']?['X-Run-Since']}"
                  },
                  "runAfter": { "Set-Control-Started": [ "Succeeded" ] },
                  "type": "SetVariable"
                },
                "Set-Control-Started": {
                  "description": "Set the started date and time using the returned value to get SQL adjusted milliseconds",
                  "inputs": {
                    "name": "Control-Started",
                    "value": "@{outputs('Record-Control-Status-Start')['headers']?['X-Run-Identifier']}"
                  },
                  "runAfter": { "Record-Control-Status-Start": [ "Succeeded" ] },
                  "type": "SetVariable"
                }
              },
              "runAfter": { "Scope-Target-OAUTH": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Target-OAUTH": {
              "actions": {
                "Get-TargetOAUTHToken": {
                  "inputs": {
                    "body": "@variables('TargetOAUTHCredentials')",
                    "headers": { "Content-Type": "application/x-www-form-urlencoded" },
                    "method": "POST",
                    "uri": "@parameters('TargetOAUTHEndpoint')"
                  },
                  "runAfter": {},
                  "type": "Http"
                },
                "Parse-TargetOAUTHToken": {
                  "inputs": {
                    "content": "@body('Get-TargetOAUTHToken')",
                    "schema": {
                      "properties": { "access_token": { "type": "string" } },
                      "type": "object"
                    }
                  },
                  "runAfter": { "Validate-Scope-Target-OAUTH": [ "Succeeded" ] },
                  "type": "ParseJson"
                },
                "Set-TargetOAUTHToken": {
                  "inputs": {
                    "name": "TargetOAUTHToken",
                    "value": "@body('Parse-TargetOAUTHToken')?['access_token']"
                  },
                  "runAfter": { "Parse-TargetOAUTHToken": [ "Succeeded" ] },
                  "type": "SetVariable"
                },
                "Validate-Scope-Target-OAUTH": {
                  "actions": {},
                  "else": {
                    "actions": {
                      "Set-Scope-Target-OAUTH-Fail": {
                        "inputs": {
                          "name": "Control-Error",
                          "value": "@int('__ERROR__')"
                        },
                        "runAfter": { "Set-Scope-Target-OAUTH-Fail-Message": [ "Succeeded" ] },
                        "type": "SetVariable"
                      },
                      "Set-Scope-Target-OAUTH-Fail-Message": {
                        "inputs": {
                          "name": "Control-Error-Message",
                          "value": "Target OAUTH Failed"
                        },
                        "runAfter": {},
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": { "and": [ { "equals": [ "@outputs('Get-TargetOAUTHToken')['statusCode']", 200 ] } ] },
                  "runAfter": { "Get-TargetOAUTHToken": [ "Succeeded" ] },
                  "type": "If"
                }
              },
              "runAfter": { "Scope-Get-Secrets": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Update-Status-Entities": {
              "actions": {
                "Record-Control-Status-Entities": {
                  "inputs": {
                    "headers": {
                      "Authorization": "Bearer @{variables('TargetOAUTHToken')}",
                      "Content-Type": "application/json",
                      "Ocp-Apim-Subscription-Key": "@variables('TargetOAUTHKey')",
                      "X-Run-Identifier": "@variables('Control-Started')",
                      "X-Run-Status": "@{variables('Control-Status')}"
                    },
                    "method": "PATCH",
                    "uri": "@parameters('TargetControlEndpoint')"
                  },
                  "runAfter": { "Set-Control-Status-Entities": [ "Succeeded" ] },
                  "type": "Http"
                },
                "Set-Control-Status-Entities": {
                  "inputs": {
                    "name": "Control-Status",
                    "value": 8
                  },
                  "runAfter": {},
                  "type": "SetVariable"
                }
              },
              "runAfter": { "Scope-Source-OAUTH": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Update-Status-Extract": {
              "actions": {
                "Record-Control-Status-Extract": {
                  "inputs": {
                    "headers": {
                      "Authorization": "Bearer @{variables('TargetOAUTHToken')}",
                      "Content-Type": "application/json",
                      "Ocp-Apim-Subscription-Key": "@variables('TargetOAUTHKey')",
                      "X-Run-Identifier": "@variables('Control-Started')",
                      "X-Run-Status": "@{variables('Control-Status')}"
                    },
                    "method": "PUT",
                    "uri": "@parameters('TargetControlEndpoint')"
                  },
                  "runAfter": { "Set-Control-Status-Extract": [ "Succeeded" ] },
                  "type": "Http"
                },
                "Set-Control-Status-Extract": {
                  "inputs": {
                    "name": "Control-Status",
                    "value": 32
                  },
                  "runAfter": {},
                  "type": "SetVariable"
                }
              },
              "runAfter": { "Scope-Entities": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Update-Status-Source-Login": {
              "actions": {
                "Record-Control-Status-Source-Login": {
                  "description": "Record that an attempt to login to the provider API endpoint and obtain their token is about to start",
                  "inputs": {
                    "headers": {
                      "Authorization": "Bearer @{variables('TargetOAUTHToken')}",
                      "Content-Type": "application/json",
                      "Ocp-Apim-Subscription-Key": "@variables('TargetOAUTHKey')",
                      "X-Run-Identifier": "@variables('Control-Started')",
                      "X-Run-Status": "@{variables('Control-Status')}"
                    },
                    "method": "PATCH",
                    "uri": "@parameters('TargetControlEndpoint')"
                  },
                  "runAfter": { "Set-Control-Status-Source-Login": [ "Succeeded" ] },
                  "type": "Http"
                },
                "Set-Control-Status-Source-Login": {
                  "inputs": {
                    "name": "Control-Status",
                    "value": "@parameters('StatusLogin')"
                  },
                  "runAfter": {},
                  "type": "SetVariable"
                },
                "Validate-Scope-Update-Status-Source-Login": {
                  "actions": {},
                  "else": {
                    "actions": {
                      "Scope-Update-Status-Source-Login-Fail": {
                        "inputs": {
                          "name": "Control-Error",
                          "value": "@int('__ERROR__')"
                        },
                        "runAfter": { "Scope-Update-Status-Source-Login-Message": [ "Succeeded" ] },
                        "type": "SetVariable"
                      },
                      "Scope-Update-Status-Source-Login-Message": {
                        "inputs": {
                          "name": "Control-Error-Message",
                          "value": "Failed to Record Login Status"
                        },
                        "runAfter": {},
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": { "and": [ { "equals": [ "@outputs('Record-Control-Status-Source-Login')['statusCode']", 202 ] } ] },
                  "runAfter": { "Record-Control-Status-Source-Login": [ "Succeeded" ] },
                  "type": "If"
                }
              },
              "runAfter": { "Scope-Start-Status": [ "Succeeded" ] },
              "type": "Scope"
            },
            "Scope-Update-Status-Transform": {
              "actions": {
                "Record-Control-Status-Transform": {
                  "inputs": {
                    "headers": {
                      "Authorization": "Bearer @{variables('TargetOAUTHToken')}",
                      "Content-Type": "application/json",
                      "Ocp-Apim-Subscription-Key": "@variables('TargetOAUTHKey')",
                      "X-Run-Identifier": "@variables('Control-Started')",
                      "X-Run-Status": "@{variables('Control-Status')}"
                    },
                    "method": "PUT",
                    "uri": "@parameters('TargetControlEndpoint')"
                  },
                  "runAfter": { "Set-Control-Status-Transform": [ "Succeeded" ] },
                  "type": "Http"
                },
                "Set-Control-Status-Transform": {
                  "inputs": {
                    "name": "Control-Status",
                    "value": "@parameters('StatusTransforming')"
                  },
                  "runAfter": {},
                  "type": "SetVariable"
                },
                "Validate-Scope-Update-Status-Transform": {
                  "actions": {
                    "Set-Control-Status-Report-Success": {
                      "inputs": {
                        "name": "Control-Status",
                        "value": "@parameters('StatusReporting')"
                      },
                      "runAfter": {},
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "Scope-Update-Status-Transform-Fail": {
                        "inputs": {
                          "name": "Control-Error",
                          "value": "@int('__ERROR__')"
                        },
                        "runAfter": { "Scope-Update-Status-Transform-Fail-Message": [ "Succeeded" ] },
                        "type": "SetVariable"
                      },
                      "Scope-Update-Status-Transform-Fail-Message": {
                        "inputs": {
                          "name": "Control-Error-Message",
                          "value": "Failed to record status as Transforming"
                        },
                        "runAfter": {},
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": { "and": [ { "equals": [ "@outputs('Record-Control-Status-Transform')['statusCode']", 202 ] } ] },
                  "runAfter": { "Record-Control-Status-Transform": [ "Succeeded" ] },
                  "type": "If"
                }
              },
              "description": "Trigger the transformation of the changes",
              "runAfter": { "Scope-Attachments": [ "Succeeded" ] },
              "type": "Scope"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "SecretsAudience": {
              "defaultValue": "https://vault.azure.net",
              "type": "String"
            },
            "SourceEndpoint": {
              "defaultValue": "[variables('dataPathUri')]",
              "type": "String"
            },
            "SourceEntities": {
              "defaultValue": [ "users", "portfolios", "sites", "surveys", "surveysections", "surveysectionelements", "deleted" ],
              "type": "Array"
            },
            "SourceOAUTHEndpoint": {
              "defaultValue": "[variables('loginUri')]",
              "type": "String"
            },
            "SourceOAUTHId": {
              "defaultValue": "[parameters('kycloudApiEmail')]",
              "type": "String"
            },
            "SourceOAUTHKeyUri": {
              "defaultValue": "[variables('keyVaultSecretKycloudApiToken')]",
              "type": "String"
            },
            "SourceOAUTHSecretUri": {
              "defaultValue": "[variables('keyVaultSecretKycloudApiPassword')]",
              "type": "String"
            },
            "StatusAttachments": {
              "defaultValue": 8,
              "type": "Int"
            },
            "StatusEntities": {
              "defaultValue": 8,
              "type": "Int"
            },
            "StatusExtracting": {
              "defaultValue": 32,
              "type": "Int"
            },
            "StatusLogin": {
              "defaultValue": 4,
              "type": "Int"
            },
            "StatusReporting": {
              "defaultValue": 100,
              "type": "Int"
            },
            "StatusStart": {
              "defaultValue": 1,
              "type": "Int"
            },
            "StatusTransforming": {
              "defaultValue": 64,
              "type": "Int"
            },
            "TargetControlEndpoint": {
              "defaultValue": "[concat(variables('dataPathUri'),'/','load')]",
              "type": "String"
            },
            "TargetEndpoint": {
              "defaultValue": "[variables('dataPathUri')]",
              "type": "String"
            },
            "TargetOAUTHCredentialsUri": {
              "defaultValue": "[variables('keyVaultSecretCdcEventsTokenRequestPayload')]",
              "type": "String"
            },
            "TargetOAUTHEndpoint": {
              "defaultValue": "[parameters('internalOAuthTokenEndpoint')]",
              "type": "String"
            },
            "TargetOAUTHKeyUri": {
              "defaultValue": "[variables('keyVaultSecretCdcEventsSubscriptionKey')]",
              "type": "String"
            }
          },
          "triggers": {
            "Recurrence": {
              "recurrence": {
                "frequency": "Day",
                "interval": 1,
                "schedule": { "hours": [ "0" ] }
              },
              "type": "Recurrence"
            }
          }
        },
        "parameters": {}
      }
    }
  ],
  "outputs": {
    "logicAppPrincipalId": {
      "value": "[reference(variables('logicAppId'), '2019-05-01', 'Full').identity.principalId]",
      "type": "string"
    }
  },
  "contentVersion": "1.0.0.0"
}
